---
name: タイミング不整合修正
overview: LayeredImages のスクロールタイミングを固定比率(20%/60%/20%)から絶対時間(800ms/scrollTime/800ms)に変更し、DawnPage の periodDuration 計算と整合させる。
todos:
  - id: fix-scroll-timing
    content: LayeredImages の calculateScrollProgress を固定比率から絶対時間(800ms)に変更
    status: completed
  - id: test-timing
    content: 紅摺絵・錦絵で indicator とスクロールが同時に終わることを確認
    status: completed
---

# タイミング不整合の修正

## 問題の原因

- **DawnPage**: `periodDuration = scrollTime + 1600ms` (800ms開始 + 800ms終了)
- **LayeredImages**: `periodDuration の 20%/60%/20%` でスクロール時間を計算

この2つが整合していないため、スクロールが早く終わる。

## 修正方針

LayeredImages の `calculateScrollProgress` を**固定比率**から**絶対時間**に変更する。

### Before (固定比率)

```
periodDuration の 20% → 開始待機
periodDuration の 60% → スクロール  
periodDuration の 80% → 終了待機
```

### After (絶対時間)

```
0 ~ 800ms           → 開始待機
800ms ~ (duration - 800ms) → スクロール
(duration - 800ms) ~ duration → 終了待機
```

---

## 修正箇所

### [src/components/dawn/LayeredImages.jsx](src/components/dawn/LayeredImages.jsx)

`calculateScrollProgress` 関数を変更:

```javascript
// Before: 固定比率
const calculateScrollProgress = (elapsed, duration) => {
  const overallProgress = elapsed / duration
  if (overallProgress <= 0.2) return 0
  if (overallProgress >= 0.8) return 1
  return (overallProgress - 0.2) / 0.6
}

// After: 絶対時間 (800ms 固定)
const VIEW_TIME = 800 // 開始/終了の待機時間

const calculateScrollProgress = (elapsed, duration) => {
  if (elapsed <= VIEW_TIME) return 0                    // 開始待機
  if (elapsed >= duration - VIEW_TIME) return 1        // 終了待機
  
  const scrollTime = duration - (VIEW_TIME * 2)        // スクロール時間
  const scrollElapsed = elapsed - VIEW_TIME
  return scrollElapsed / scrollTime                    // 線形補間
}
```

---

## 修正後の動作確認

| Period | duration | 開始待機 | スクロール | 終了待機 |

|--------|----------|---------|-----------|---------|

| 紅摺絵 | 6880ms | 800ms | 5280ms | 800ms |

| 錦絵 | 8640ms | 800ms | 7040ms | 800ms |

これで DawnPage の計算式 `scrollTime + 1600ms` と完全に整合する。