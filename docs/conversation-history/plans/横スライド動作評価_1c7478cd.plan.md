---
name: 横スライド動作評価
overview: スマホ幅（375px）での横スライド機能の動作を評価し、発見された問題点と改善案をまとめました。
todos:
  - id: fix-calculate-scroll-progress
    content: calculateScrollProgressをコンポーネント外に移動して依存配列問題を解消
    status: pending
  - id: investigate-auto-stop
    content: 自動アニメーション早期停止の原因を実機テストで調査
    status: pending
---

# スマホ幅での横スライド動作評価レポート

## 評価結果サマリー

| 項目 | 状態 |

|------|------|

| モバイル検出 | 正常 |

| 横スクロールCSS | 正常 |

| 自動横スクロールアニメーション | 問題あり |

| 手動横スクロール | 正常（CSS設定） |

---

## 発見された問題

### 1. 自動アニメーションの早期停止（重大）

**現象**: ページ読み込み後、約3-4秒で自動アニメーションが停止し、「再生」ボタンに戻る

**原因推定**: [`DawnPage.jsx`](src/pages/DawnPage.jsx) の行204-225で、`touchstart` イベントがユーザー操作として検出されている可能性

```77:78:src/pages/DawnPage.jsx
  useEffect(() => {
    if (!isAutoAnimating || isTransitioning || userInteractedRef.current) return
```

ブラウザ自動化ツールの操作が `touchstart` を発火させている可能性があるが、実機でも同様の問題が起きる可能性がある。

### 2. `calculateScrollProgress` のメモ化漏れ（軽微）

[`LayeredImages.jsx`](src/components/dawn/LayeredImages.jsx) の行56-64で定義されている `calculateScrollProgress` 関数は `useCallback` でメモ化されていないため、useEffect の依存配列に含まれていると不必要な再レンダリングが発生する。

```184:src/components/dawn/LayeredImages.jsx
  }, [isActive, isAutoAnimating, isSingleImage, periodDuration, syncElapsedTime, calculateScrollProgress])
```

### 3. 期間計算のズレの可能性（軽微）

[`DawnPage.jsx`](src/pages/DawnPage.jsx) の `calculatePeriodDuration` と `GalleryIndicators` の `animationDuration` が同期しているが、横スクロールの `VIEW_TIME`（800ms）と全体の計算が一致していない場合、スクロール位置とインジケーターがずれる可能性がある。

---

## 正常に動作している部分

### モバイル検出

```37:43:src/pages/DawnPage.jsx
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth <= 900)
    checkMobile()
    window.addEventListener('resize', checkMobile)
    return () => window.removeEventListener('resize', checkMobile)
  }, [])
```

### 横スクロールCSS設定

```67:85:src/components/dawn/LayeredImages.css
@media (max-width: 900px) {
  .layered-images {
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    ...
  }
```

### レイヤー数に応じた期間計算

```51:66:src/pages/DawnPage.jsx
  const calculatePeriodDuration = useCallback((periodIndex) => {
    const periodKey = PERIOD_ORDER[periodIndex]
    const period = PERIODS[periodKey]
    
    if (!isMobile || period.imageCount <= 1) {
      return 3333 // Desktop or single image: 3.33 seconds
    }
    
    // Mobile with multiple layers: calculate based on scroll distance
    const extraLayers = period.imageCount - 1
    const scrollTime = extraLayers * 1760 // ms per layer at 100px/s
    const viewingTime = 1600 // 800ms start + 800ms end viewing
    
    return scrollTime + viewingTime
  }, [isMobile])
```

---

## 推奨される修正

### 優先度: 高

1. **`calculateScrollProgress` をコンポーネント外に移動またはメモ化**

   - 純粋関数のためコンポーネント外に定義するのが最適

2. **ユーザー操作検出の調整**

   - 必要に応じて、自動スクロール中のtouchイベント検出を調整

### 優先度: 中

3. **手動確認の実施**

   - 実機（iPhone/Android）でのテストを推奨
   - ブラウザDevToolsのモバイルエミュレーターでは正確な動作検証が困難な場合がある